# Hướng Dẫn (Bảo mật): Cài đặt Mật khẩu cho Website bằng Nginx Basic Authentication

## Giới thiệu

Đây là phương pháp được khuyến nghị để bảo vệ ứng dụng của bạn một cách nhanh chóng và hiệu quả. Chúng ta sẽ sử dụng tính năng "Basic Authentication" của web server Nginx để yêu cầu tên đăng nhập và mật khẩu trước khi bất kỳ ai có thể xem nội dung trang web.

**Quan trọng:** Hướng dẫn này nên được thực hiện **SAU KHI** bạn đã kích hoạt HTTPS bằng Certbot (xem Hướng dẫn 6).

**Ưu điểm:**
-   **An toàn cao:** Mật khẩu được kiểm tra ở cấp độ web server, trước khi yêu cầu được chuyển đến ứng dụng Node.js.
-   **Triển khai nhanh:** Chỉ mất vài phút để cấu hình.
-   **Bảo vệ toàn diện:** Cả frontend và backend API đều được bảo vệ.
-   **Không cần sửa code:** Toàn bộ cấu hình nằm trong Nginx.

---

## Các bước Thực hiện

### Bước 1: Cài đặt Công cụ tạo Mật khẩu

Chúng ta cần một công cụ gọi là `htpasswd` để tạo file mật khẩu đã được mã hóa. Công cụ này nằm trong gói `apache2-utils`.

1.  Kết nối vào VPS của bạn qua SSH.
2.  Chạy lệnh sau để cài đặt:
    ```bash
    sudo apt update
    sudo apt install apache2-utils -y
    ```

### Bước 2: Tạo File Mật khẩu

Lệnh này sẽ tạo một file mới tên là `.htpasswd` trong thư mục `/etc/nginx/`, chứa tên người dùng và mật khẩu đã được mã hóa.

1.  Chạy lệnh sau. Hãy thay `your_admin_user` bằng tên đăng nhập bạn muốn.
    ```bash
    sudo htpasswd -c /etc/nginx/.htpasswd your_admin_user
    ```
    -   **Lưu ý:** Tùy chọn `-c` (create) chỉ được dùng cho **lần đầu tiên** để tạo file. Nếu sau này bạn muốn thêm một người dùng khác, hãy bỏ tùy chọn `-c` đi.

2.  Bạn sẽ được nhắc nhập và xác nhận mật khẩu mới. Hãy nhập một mật khẩu đủ mạnh và ghi nhớ nó.

### Bước 3: Cập nhật Cấu hình Nginx (Bước Quan Trọng Nhất)

Bây giờ, chúng ta sẽ chỉnh sửa file cấu hình Nginx của trang web để yêu cầu mật khẩu, đồng thời tạo một "lối đi riêng" không cần mật khẩu cho AWS Lambda. Cấu hình này giả định bạn đã chạy Certbot.

1.  Mở file cấu hình của bạn:
    ```bash
    sudo nano /etc/nginx/sites-available/ppc.tababyco.com
    ```

2.  Sửa đổi nội dung file để trông giống như sau. Certbot sẽ tự động tạo ra hầu hết cấu trúc này. Bạn chỉ cần **thêm vào các dòng `auth_basic`** ở những vị trí được chỉ định.

    ```nginx
    # Khối server này được Certbot tạo ra để chuyển hướng tất cả
    # lưu lượng truy cập HTTP (cổng 80) sang HTTPS (cổng 443).
    # KHÔNG THÊM MẬT KHẨU VÀO ĐÂY.
    server {
        listen 80;
        server_name ppc.tababyco.com;
        return 301 https://$host$request_uri;
    }

    # Đây là khối server chính cho ứng dụng của bạn, chạy trên HTTPS.
    # CHÚNG TA SẼ THÊM CÁC QUY TẮC BẢO MẬT VÀO ĐÂY.
    server {
        listen 443 ssl http2;
        server_name ppc.tababyco.com;

        # ==========================================================
        # == PHẦN 1: BẬT MẬT KHẨU CHO TOÀN BỘ WEBSITE              ==
        # THÊM 2 DÒNG NÀY VÀO ĐÂY
        # ==========================================================
        auth_basic "Restricted Access - Please Log In";
        auth_basic_user_file /etc/nginx/.htpasswd;
        # ==========================================================

        # Các dòng SSL này được Certbot tự động thêm vào.
        ssl_certificate /etc/letsencrypt/live/ppc.tababyco.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/ppc.tababyco.com/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

        # Đường dẫn đến thư mục build của frontend
        root /var/www/Ads-auto/dist; # <-- Thay bằng đường dẫn chính xác của bạn
        index index.html;

        location / {
            try_files $uri $uri/ /index.html;
        }

        # ==========================================================
        # == PHẦN 2: TẠO "LỐI ĐI RIÊNG" KHÔNG MẬT KHẨU CHO AWS LAMBDA ==
        # Cấu hình đặc biệt này phải được đặt TRƯỚC location /api chung.
        # ==========================================================
        location /api/stream-ingest {
            # TẮT yêu cầu mật khẩu cho riêng location này.
            auth_basic off;

            # Vẫn giữ nguyên các cài đặt proxy để chuyển yêu cầu đến backend.
            proxy_pass http://localhost:4001;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }
        # ==========================================================

        # Chuyển tất cả các yêu cầu /api/... khác đến backend
        # (Nó sẽ kế thừa yêu cầu mật khẩu từ cấu hình server chung)
        location /api {
            proxy_pass http://localhost:4001;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }
    }
    ```
3.  Lưu file và thoát trình soạn thảo (nhấn `Ctrl + X`, sau đó `Y`, và `Enter`).

### Bước 4: Kiểm tra và Khởi động lại Nginx

1.  Luôn kiểm tra cú pháp file cấu hình trước khi khởi động lại:
    ```bash
    sudo nginx -t
    ```
    -   Nếu bạn thấy thông báo `syntax is ok` và `test is successful`, mọi thứ đã sẵn sàng.

2.  Áp dụng các thay đổi bằng cách khởi động lại Nginx:
    ```bash
    sudo systemctl restart nginx
    ```

---

## Hoàn tất!

Bây giờ, hãy thử truy cập vào trang web `https://ppc.tababyco.com` của bạn. Trình duyệt sẽ hiện lên một hộp thoại yêu cầu bạn nhập tên người dùng và mật khẩu đã tạo ở Bước 2.

-   **Người dùng (bạn):** Sẽ phải đăng nhập để xem giao diện.
-   **AWS Lambda:** Sẽ gửi dữ liệu đến `/api/stream-ingest` một cách trơn tru mà không bị hỏi mật khẩu, vì kết nối đã an toàn qua HTTPS.

Bạn đã bảo vệ thành công ứng dụng của mình mà vẫn đảm bảo luồng dữ liệu tự động hoạt động chính xác.