-- =============================================================================
-- Migration: Create Sponsored Products Search Term Report Table
-- =============================================================================
--
-- This script creates the `sponsored_products_search_term_report` table.
-- This table stores the detailed performance data fetched from the Amazon Ads API,
-- providing insights into which customer search terms are performing well for
-- specific campaigns, ad groups, and targeting expressions.
--
-- The primary key is a composite of several fields to ensure that each record
-- representing a unique combination of date, campaign, ad group, search term,
-- and targeting is stored only once.

CREATE TABLE IF NOT EXISTS sponsored_products_search_term_report (
    id SERIAL PRIMARY KEY,
    report_date DATE NOT NULL,
    campaign_id BIGINT NOT NULL,
    campaign_name TEXT,
    ad_group_id BIGINT NOT NULL,
    ad_group_name TEXT,
    keyword_id BIGINT,
    keyword_bid NUMERIC(10, 2),
    targeting TEXT,
    match_type VARCHAR(50),
    customer_search_term TEXT,
    impressions INTEGER,
    clicks INTEGER,
    cost_per_click NUMERIC(10, 2),
    spend NUMERIC(10, 2),
    seven_day_total_sales NUMERIC(10, 2),
    seven_day_acos NUMERIC(10, 4),
    seven_day_roas NUMERIC(10, 4),
    seven_day_total_orders INTEGER,
    seven_day_total_units INTEGER,
    seven_day_advertised_sku_sales NUMERIC(10, 2),
    seven_day_advertised_sku_units INTEGER,
    seven_day_other_sku_sales NUMERIC(10, 2),
    seven_day_other_sku_units INTEGER,
    asin VARCHAR(255),
    -- Create a unique constraint to prevent duplicate rows based on the API's granularity
    CONSTRAINT unique_sp_search_term_report_entry UNIQUE (report_date, campaign_id, ad_group_id, keyword_id, customer_search_term, targeting)
);

-- Add indexes to frequently queried columns to improve performance
CREATE INDEX IF NOT EXISTS idx_sp_str_report_date ON sponsored_products_search_term_report(report_date);
CREATE INDEX IF NOT EXISTS idx_sp_str_campaign_id ON sponsored_products_search_term_report(campaign_id);
CREATE INDEX IF NOT EXISTS idx_sp_str_asin ON sponsored_products_search_term_report(asin);
CREATE INDEX IF NOT EXISTS idx_sp_str_keyword_id ON sponsored_products_search_term_report(keyword_id);


-- =============================================================================
-- Grant Permissions to Application User
-- =============================================================================
-- IMPORTANT: Replace 'yourdbuser' with the actual DB_USER from your .env file.
GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE sponsored_products_search_term_report TO yourdbuser;
GRANT USAGE, SELECT ON SEQUENCE sponsored_products_search_term_report_id_seq TO yourdbuser;